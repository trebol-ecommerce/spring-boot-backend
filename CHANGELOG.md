# Changelog
All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Added
- Service interface for confirming, rejecting and marking sales as completed
- Support sorting product lists by item count (the amount of products held on each)
- Properties to configure the guest user (a public account only enabled for checking out)
  - `trebol.security.guestUserEnabled` - Can be true or false
  - `trebol.security.guestUserName` - Any non-blank string; also acts as its password
- `SellDetail` entity now has a `description` field, which is meant to summarize its metadata in a human-readable string and remove dependency to the `Product` entity 
  - *NOTE*: This will affect normal operation, check the next tagged release for a migration script named `migrate-to-mariadb-schema-v2.3.5.sql`
- When fetching data, filters by category may include descendant of lower level categories
  - For example, assumming that category A includes subcategories AB and AC, filtering 'by category A' may include children from subcategories AB and AC as well 
  - This applies for filtering categories and products
  - Behavior before was to fetch only direct descendants of a given category

### Changed
- The transaction token for the (frontend) checkout result page  is passed through query param instead of path param

### Fixed
- Incorrect amount value given to Webpay (net value instead of total value)
- Two very important equations when calculating sell totals
- Incorrect protocol for MariaDB JDBC URL
- Webpay Plus was unable to redirect users to the callback URL; added `null` in list of allowed CORS origins
- Incongruent binding of query parameters to data search filters for products
- Guest can call the `/access` API and be returned a `200 OK` response
- Change integration type for payments with Webpay Plus when production mode is not enabled
  - Now uses `TEST` as recommended by `@TransbankDevelopers`
  - Was using `MOCK` which is not very well documented

## [v2.0.0] - 2022-01-20

### Changed
- Reformat `pom.xml` file
  - Add comments
  - Update properties
    - Add keys for code coverage ratio
    - Add keys to version of all dependencies and plugins (except those inferred from parent)
    - Rename some properties
  - Remove unused `jcenter` repository
  - Bump plugins
    - `maven-compiler-plugin` - from `3.1` to `3.9.0`
    - `maven-war-plugin` - from `3.3.1` to `3.3.2`
  - Remove old `Oracle Java EE endorsed API` artifacts
    - In reality, these have been replaced by Jakarta EE endorsed API
- **Bump Spring Boot Starter POM to v2.6.2 [BREAKING CHANGE]**
  - Deprecated/unsupported properties; update configuration described in `application.properties`
- Update license file; add headers to all source files
- Creating products through a `POST /data/products` call does not cascade creation of other entities

### Removed
- Clean up deprecated API resources
  - `/public/categories`
  - `/public/products`
  - `/public/products/{barcode}`
- Remove any reference to the depreacted `amount` property in the Receipt entity 

## [v1.2.0] - 2022-01-07

### Added
- CRUD operations support for `Product List`
  - Also for managing contents of individual lists, as described by resource `/data/product_list_contents` in the API
- Schema SQL script for MariaDB
- Maximum page size limit, parametrizable through `properties` files

### Changed
- Updated security rule for `GET /data/products` to: do not require any authority
- Simplified method signature for `readMany` method in `IDataController`
- Updated BD schema diagram `schema.png` 

### Removed
- Clean up deprecated resources
  - `/data/customers/{idNumber}`
  - `/data/images/{code}`
  - `/data/product_categories/{parentCode}`
  - `/data/products/{barcode}`
  - `/data/sales/{buyOrder}`
  - `/data/salespeople/{idNumber}`
  - `/data/users/{name}`
  - `/public/categories/{parentId}`

### Deprecated
- Paths to be superseded
  - `/public/products`
  - `/public/products/{barcode}`

## [v1.1.2] - 2021-12-27

### Added
- Support for sorting data through query parameters

### Fixed
- Unable to update products due to possible null pointer in description
- CORS mappings for `/access` API

### Tests
- Added unit tests for predicate services (responsible for parsing query params to filtering conditions)
- Improved quality of some unit tests

## [v1.1.1.1] - 2021-12-08

### Fixed
- Issues during checkout:
  - Incorrect validation API endpoints for integrating Webpay Plus SDK
  - JPA transactions failing between service calls
  - Data missing in receipt after checkout is complete

## [v1.1.1] - 2021-12-06

### Added
- Using [SonarCloud](https://sonarcloud.io) to automate project building and code analyzing
- Include maintainability and reliability badges, generated by SonarCloud, in `README.md`
- Support for query parameters in PUT requests to `/data` resources
- Unit tests providing an approximate of 20% codebase coverage
- Database schema file `/schema.png`

### Changed
- Removed request authentication for remapped paths in `/data/product_categories/*` to make them publicly available to anonymous users
- Updated `Person` schema by splitting `name` property into two properties `firstName` and `lastName`
- Updated `Sell`  schema by adding properties `taxValue`, `transportValue`, `totalValue` and `totalItems`
- Updated `Receipt` schema by adding properties `token`, `taxValue`, `transportValue`, `totalValue` and `totalItems`
- Updated `SellDetail` and `ReceiptDetail` schemas by adding property `unitValue` in both
- Updated `ProductCategory` schema by changing data type of `code` from `integer` to `string`
- Delegate API authorized access requirements to each REST controller method, instead of using HttpSecurity-centric configuration
- Improvements on JPA entities
  - `BillingCompany` - added unique constraint on `name`
  - `BillingType` - added unique constraint on `name`
  - `Image` - added unique constraint on `code`, `filename` and `url`
  - `Param` - added unique constraint that uses both `category` and `name`
  - `PaymentType` - added unique constraint on `name`
  - `Permission` - added unique constraint on `code`
  - `Person` - added index to `firstName` and `lastName`
  - `Product` - added index to `name`
  - `Sell` - added index to `date` and `transactionToken`
  - `SellStatus` - added unique constraint on `code` and `name`
- Refactored services in `org.trebol.jpa` package for better separation of concerns

### Deprecated
- Path `/public/categories` and `/public/categories/{parentId}`, mapped under `PublicCategoriesController` - Thanks @ParundeepSingh
- Property `amount` of `Sell` and their getters; must use `totalValue` instead
- Parameterized paths
  - `/data/customers/{idNumber}` replaced by `/data/customers?idNumber={}`
  - `/data/images/{code}` replaced by `/data/images?code={}`
  - `/data/products/{code}` replaced by `/data/products?barcode={}`
  - `/data/sales/{buyOrder}` replaced by `/data/sales?buyOrder={}`
  - `/data/salespeople/{idNumber}` replaced by `/data/salespeople?idNumber={}`
  - `/data/users/{name}` replaced by `/data/users?name={}`

### Removed
- Entity class `Session`, not used in the codebase

## [v1.0.4] - 2021-10-21

### Changed
- Clean up entities and remove redundant annotation values - Thanks to @trangntt-016

### Fix
- Fix resolving paging parameters where it would always get the default value.

### Security
- Restrict users from deleting their own account - Thanks to @trangntt-016


## [v1.0.3] - 2021-09-23

### Changed
- `/public/receipt/{id}` updated with `id` parameter now called `token` and referencing sell payment token

### Fixed
- Fix default application parameters related to the checkout/payment service
    - Self-callback URL after clients navigates checkout
    - Success/Failure page URL to send customers to, after checkout
- Add missing sales filters required to fetch data during the checkout flow
- Add missing mock data into `data.sql` that is needed to invoke `/public/about`
- `ReceiptPojo` now uses `Instant` to represent dates, just like `Sell` and `SellPojo`


## [v1.0.0] - 2021-09-20

First public version.
